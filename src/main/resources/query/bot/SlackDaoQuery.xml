<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.honsul.inthewood.bot.slack.dao.SlackDao">
                      
    <update id="updateSlackUser" parameterType="SlackUser">
      INSERT INTO SLACK_USER(
        USER_ID, USER_NAME, TEAM_ID, TEAM_NAME, ACCESS_TOKEN, 
        BOT_USER_ID, BOT_ACCESS_TOKEN, BOT_IM_CHANNEL, INSERT_DT, UPDATE_DT)
      VALUES (
        #{userId}, #{userName}, #{teamId}, #{teamName}, #{accessToken}, 
        #{botUserId}, #{botAccessToken}, #{botImChannel}, now(), now())
          ON DUPLICATE KEY
      UPDATE USER_NAME = #{userName}
           , TEAM_ID = #{teamId}
           , TEAM_NAME = #{teamName}
           , ACCESS_TOKEN = #{accessToken}
           , BOT_USER_ID = #{botUserId}
           , BOT_ACCESS_TOKEN = #{botAccessToken}
           , BOT_IM_CHANNEL = #{botImChannel}
           , UPDATE_DT = now()    
    </update>    
    
    <select id="getSlackBotAcccessTokenByUserId" resultType="string" parameterType="string">
      SELECT BOT_ACCESS_TOKEN
        FROM SLACK_USER
       WHERE USER_ID = #{vo}
    </select>

    <select id="getSlackUserAcccessTokenByUserId" resultType="string" parameterType="string">
      SELECT ACCESS_TOKEN
        FROM SLACK_USER
       WHERE USER_ID = #{vo}
    </select>

    <select id="selectSlackSubscription" resultType="SlackSubscription" parameterType="SlackSlashCommand">
      SELECT a.USER_ID
           , b.USER_NAME
          , a.SUBSCRIPTION_ID
          , a.RESORT_ID
          , CASE WHEN a.RESORT_ID = '*' 
                 THEN CONCAT('전국 ', (SELECT COUNT(distinct RESORT_ID) FROM BOOKING), '개 휴양림') 
              ELSE c.RESORT_NM 
            END as RESORT_NM
          , c.HOMEPAGE
          , c.ADDRESS
          , CASE WHEN a.BOOKING_DT = 'holiday'
                 THEN '연휴'
                 ELSE a.BOOKING_DT
              END as BOOKING_DT
          , a.*
        FROM SLACK_SUBSCRIBER a
        JOIN SLACK_USER b
          ON b.USER_ID = a.USER_ID
        LEFT JOIN RESORT c
          ON c.RESORT_ID = a.RESORT_ID
       WHERE a.USER_ID = #{userId}
         AND a.CHANNEL = #{channelId}
       ORDER BY a.SUBSCRIPTION_ID
    </select>

</mapper>

