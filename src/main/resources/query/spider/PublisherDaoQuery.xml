<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.honsul.inthewood.spider.dao.PublisherDao">
                   
    <select id="selectNewEntryBookings" resultType="cmap" parameterType="Resort">
      SELECT a.RESORT_ID
           , h.RESORT_NM
           , h.HOMEPAGE
           , h.PHOTO
           , h.REGION
           , h.ADDRESS
           , h.PHONE
           , CONCAT(DATE_FORMAT(a.BOOKING_DT, '%Y-%m-%d'), ' ', 
               CASE DATE_FORMAT(a.BOOKING_DT, '%w') 
                    WHEN 0 THEN '일요일' 
                    WHEN 1 THEN '월요일' 
                    WHEN 2 THEN '화요일' 
                    WHEN 3 THEN '수요일' 
                    WHEN 4 THEN '목요일' 
                    WHEN 5 THEN '금요일' 
                    WHEN 6 THEN '토요일' 
                END) as BOOKING_DT
           , a.ROOM_NM
           , r.ROOM_TYPE
           , r.ROOM_TYPE_NM
           , r.OCCUPANCY
           , FORMAT(r.PEAK_PRICE, 0) as PEAK_PRICE
           , FORMAT(r.PRICE, 0) as PRICE
        FROM BOOKING a
        JOIN RESORT h
          ON h.RESORT_ID = a.RESORT_ID
        JOIN ROOM r
          ON r.RESORT_ID = a.RESORT_ID
         AND r.ROOM_NM = a.ROOM_NM
        LEFT JOIN BOOKING_PREV b 
          ON b.RESORT_ID = a.RESORT_ID
         AND b.BOOKING_DT = a.BOOKING_DT
         AND b.ROOM_NM = a.ROOM_NM
       WHERE a.RESORT_ID = #{resortId}
         AND b.RESORT_ID IS NULL
    </select>
    
    <select id="selectBookingSubscriber" resultType="Subscriber" parameterType="map">
      SELECT a.SUBSCRIBER_ID
           , a.SUBSCRIBER_TYPE
        FROM SUBSCRIBER a
       WHERE a.BOOKING_DT = 'holiday'
         AND EXISTS (SELECT 1
                   FROM CALENDAR
                  WHERE HOLIDAY_YN = 'Y'
                    AND DT = #{bookingDt})
         AND a.RESORT_ID IN (#{resortId}, '*')
         AND a.ROOM_TYPE IN (#{roomType}, '*')
         AND a.USE_YN = 'Y'
       UNION
      SELECT a.SUBSCRIBER_ID
           , a.SUBSCRIBER_TYPE
        FROM SUBSCRIBER a
       WHERE a.BOOKING_DT = DATE_FORMAT(#{bookingDt}, '%Y%m%d')
         AND a.RESORT_ID IN (#{resortId}, '*')
         AND a.ROOM_TYPE IN (#{roomType}, '*')
         AND a.USE_YN = 'Y'
    </select>    
      
</mapper>

